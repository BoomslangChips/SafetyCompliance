@page "/inspections/{RoundId:int}"
@inject IInspectionService InspectionService
@inject IIssueService IssueService
@inject NavigationManager Navigation

<div class="page-header">
    <div>
        <button class="btn btn-link" @onclick="GoBack">&larr; Back</button>
        <h1>Inspection Checklist</h1>
    </div>
    <div class="header-actions">
        @if (_inspections.Any() && !_allComplete)
        {
            <button class="btn btn-primary" @onclick="CompleteRound">Complete Round</button>
        }
        @if (_allComplete)
        {
            <span class="status-badge status-completed">All Complete</span>
        }
    </div>
</div>

@if (_loading)
{
    <p>Loading...</p>
}
else if (!_inspections.Any())
{
    <div class="empty-state">
        <p>No equipment found for this inspection round. Make sure the plant has active equipment with checklist templates configured.</p>
    </div>
}
else
{
    <div class="progress-bar-container">
        <div class="progress-bar" style="width: @(_progress)%"></div>
        <span class="progress-text">@_completedCount / @_inspections.Count equipment complete</span>
    </div>

    @foreach (var sectionGroup in _inspections.GroupBy(i => new { i.SectionId, i.SectionName }))
    {
        var sectionInspections = sectionGroup.ToList();
        var checklistHeaders = sectionInspections
            .Where(i => i.Responses.Any())
            .SelectMany(i => i.Responses)
            .Select(r => new { r.ChecklistItemTemplateId, r.ItemName, r.SortOrder })
            .DistinctBy(r => r.ChecklistItemTemplateId)
            .OrderBy(r => r.SortOrder)
            .ToList();

        <div class="section-inspection-block">
            <div class="section-header-bar">
                <h2>@sectionGroup.Key.SectionName</h2>
                <span class="section-progress">
                    @sectionInspections.Count(i => i.IsComplete) / @sectionInspections.Count
                </span>
            </div>

            @if (checklistHeaders.Any())
            {
                <div class="checklist-table-wrapper">
                    <table class="checklist-table">
                        <thead>
                            <tr>
                                <th class="col-num">#</th>
                                <th class="col-equip">Equipment</th>
                                @foreach (var header in checklistHeaders)
                                {
                                    <th class="col-check">@header.ItemName</th>
                                }
                                <th class="col-status">Status</th>
                                <th class="col-action"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ var rowNum = 0; }
                            @foreach (var inspection in sectionInspections)
                            {
                                rowNum++;
                                <tr class="@(inspection.IsComplete ? "row-complete" : "")">
                                    <td class="col-num">@rowNum</td>
                                    <td class="col-equip">
                                        <strong>@inspection.EquipmentIdentifier</strong>
                                        @if (inspection.Size is not null)
                                        {
                                            <span class="equip-detail">@inspection.Size</span>
                                        }
                                        @if (inspection.SubTypeName is not null)
                                        {
                                            <span class="equip-detail">@inspection.SubTypeName</span>
                                        }
                                    </td>
                                    @foreach (var header in checklistHeaders)
                                    {
                                        var response = inspection.Responses
                                            .FirstOrDefault(r => r.ChecklistItemTemplateId == header.ChecklistItemTemplateId);
                                        <td class="col-check @(response?.Response == true ? "cell-pass" : response?.Response == false ? "cell-fail" : "")">
                                            @if (response is not null)
                                            {
                                                <div class="check-toggle">
                                                    <button class="toggle-yes @(response.Response == true ? "active" : "")"
                                                            @onclick="() => SubmitResponse(inspection.Id, header.ChecklistItemTemplateId, true)">&#10003;</button>
                                                    <button class="toggle-no @(response.Response == false ? "active" : "")"
                                                            @onclick="() => SubmitResponse(inspection.Id, header.ChecklistItemTemplateId, false)">&#10007;</button>
                                                </div>
                                            }
                                        </td>
                                    }
                                    <td class="col-status">
                                        @if (inspection.IsComplete)
                                        {
                                            <span class="badge-done">Done</span>
                                        }
                                        else
                                        {
                                            var answered = inspection.Responses.Count(r => r.Response.HasValue);
                                            <span class="badge-partial">@answered/@inspection.Responses.Count</span>
                                        }
                                    </td>
                                    <td class="col-action">
                                        <button class="btn btn-xs btn-warning" @onclick="() => ShowFlagIssue(inspection)">Flag</button>
                                    </td>
                                </tr>
                                @if (inspection.Responses.Any(r => r.Response == false))
                                {
                                    <tr class="failed-row">
                                        <td colspan="@(3 + checklistHeaders.Count + 2)">
                                            <span class="failed-label">Failed:</span>
                                            @foreach (var failed in inspection.Responses.Where(r => r.Response == false))
                                            {
                                                <span class="failed-tag">@failed.ItemName</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="no-checklist-msg">No checklist items configured for equipment types in this section.</p>
            }
        </div>
    }

    <div class="inspection-comments-section">
        <h2>Inspection Comments (@_comments.Count)</h2>

        @foreach (var comment in _comments)
        {
            <div class="comment-card">
                <div class="comment-header">
                    <span class="comment-author">@comment.CreatedByName</span>
                    <span class="comment-date">@comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                </div>
                <p class="comment-text">@comment.Text</p>
                @if (comment.PhotoBase64 is not null)
                {
                    <div class="comment-photo">
                        <img src="@GetPhotoSrc(comment.PhotoBase64)" alt="Comment photo" />
                    </div>
                }
            </div>
        }

        <div class="add-comment">
            <div class="form-group">
                <InputTextArea @bind-Value="_newCommentText" class="form-control" rows="2" placeholder="Add a comment about this inspection..." />
            </div>
            <button class="btn btn-primary btn-sm" @onclick="AddComment" disabled="@(string.IsNullOrWhiteSpace(_newCommentText))">Post Comment</button>
        </div>
    </div>
}

@if (_showFlagIssue)
{
    <div class="modal-overlay" @onclick="() => _showFlagIssue = false">
        <div class="modal" @onclick:stopPropagation>
            <h2>Flag Issue - @_flagEquipmentIdentifier</h2>
            <div class="form-group">
                <label>Title</label>
                <InputText @bind-Value="_flagIssueTitle" class="form-control" placeholder="Brief description of the issue" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <InputTextArea @bind-Value="_flagIssueDescription" class="form-control" rows="3" />
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select class="form-control" @onchange="OnPriorityChanged">
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-warning" @onclick="CreateFlaggedIssue">Create Issue</button>
                <button class="btn btn-secondary" @onclick="() => _showFlagIssue = false">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int RoundId { get; set; }

    private List<EquipmentInspectionDto> _inspections = [];
    private List<CommentDto> _comments = [];
    private bool _loading = true;
    private int _completedCount;
    private double _progress;
    private bool _allComplete;
    private string _newCommentText = string.Empty;

    private bool _showFlagIssue;
    private int _flagEquipmentInspectionId;
    private int _flagEquipmentId;
    private string _flagEquipmentIdentifier = "";
    private string _flagIssueTitle = string.Empty;
    private string? _flagIssueDescription;
    private IssuePriority _flagIssuePriority = IssuePriority.Medium;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _inspections = await InspectionService.GetEquipmentInspectionsAsync(RoundId);
        _comments = await IssueService.GetInspectionCommentsAsync(RoundId);
        _completedCount = _inspections.Count(i => i.IsComplete);
        _progress = _inspections.Count > 0 ? (double)_completedCount / _inspections.Count * 100 : 0;
        _allComplete = _completedCount == _inspections.Count && _inspections.Count > 0;
        _loading = false;
    }

    private async Task SubmitResponse(int equipmentInspectionId, int checklistItemTemplateId, bool response)
    {
        var dto = new SubmitResponseDto(equipmentInspectionId, checklistItemTemplateId, response, null);
        await InspectionService.SubmitResponseAsync(dto);
        await LoadData();
    }

    private async Task CompleteRound()
    {
        await InspectionService.CompleteRoundAsync(RoundId);
        Navigation.NavigateTo("/inspections");
    }

    private void ShowFlagIssue(EquipmentInspectionDto inspection)
    {
        _flagEquipmentInspectionId = inspection.Id;
        _flagEquipmentId = inspection.EquipmentId;
        _flagEquipmentIdentifier = inspection.EquipmentIdentifier;
        _flagIssueTitle = $"Issue with {inspection.EquipmentIdentifier}";
        _flagIssueDescription = null;
        _flagIssuePriority = IssuePriority.Medium;
        _showFlagIssue = true;
    }

    private void OnPriorityChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<IssuePriority>(e.Value?.ToString(), out var priority))
            _flagIssuePriority = priority;
    }

    private async Task CreateFlaggedIssue()
    {
        var dto = new IssueCreateDto(
            _flagIssueTitle, _flagIssueDescription, _flagIssuePriority,
            null, null, RoundId, _flagEquipmentInspectionId, _flagEquipmentId, null, null);
        await IssueService.CreateIssueAsync(dto, "current-user");
        _showFlagIssue = false;
    }

    private async Task AddComment()
    {
        if (string.IsNullOrWhiteSpace(_newCommentText)) return;
        var dto = new CommentCreateDto(RoundId, null, _newCommentText, null, null);
        await IssueService.AddInspectionCommentAsync(dto, "current-user");
        _newCommentText = string.Empty;
        await LoadData();
    }

    private void GoBack() => Navigation.NavigateTo("/inspections");
    private static string GetPhotoSrc(string base64) => $"data:image/jpeg;base64,{base64}";
}
